# CLAUDE.md

このファイルは、このリポジトリのコードを扱う際のClaude Code (claude.ai/code)へのガイダンスを提供します。

## プロジェクト概要

Next.js 14.2.5（App Router）、TypeScript、React 18で構築されたテトリスゲームです。シングルページのクライアントサイドアプリケーションとして実装されています。

## 技術スタック

- Next.js 14.2.5（App Router使用）
- React 18（hooks使用：useState、useEffect、useCallback）
- TypeScript（strictモード）
- 外部UIライブラリやCSSフレームワークは不使用

## コマンド

```bash
# 依存関係のインストール
npm install

# 開発サーバーの起動
npm run dev

# プロダクションビルド
npm run build

# プロダクションサーバーの起動
npm run start

# ESLintの実行
npm run lint
```

## アーキテクチャ

### ディレクトリ構造
```
/
├── app/
│   ├── page.tsx    # メインゲームコンポーネント（クライアントサイド）
│   └── layout.tsx  # メタデータを含むルートレイアウト
├── package.json
├── tsconfig.json
├── next.config.js
└── CLAUDE.md
```

### ゲーム実装の核心

ゲームロジック全体は`/app/page.tsx`に`'use client'`ディレクティブを使用した単一のReactコンポーネントとして実装されています。主要な設計判断：

1. **状態管理**：React hooksのみを使用（外部状態管理ライブラリなし）
   - `board`：ゲームグリッドを表す2次元配列（20×10）
   - `currentPiece`＆`nextPiece`：アクティブなテトリスピースと次のピース
   - `position`：現在のピースの座標
   - `score`：ゲームスコア（1ライン消去で100点、4ライン同時消去で1000点）
   - `gameOver`：ゲーム状態フラグ

2. **ピースシステム**：
   - 標準的な7種類のテトリスピース（I、O、T、L、J、S、Z）
   - 各ピースは形状マトリックスと色を持つ
   - 視覚的な差別化のため、ピースごとに固有の色を設定

3. **ゲームループ**：
   - `setInterval`を使用した自動ピース落下（500ms間隔）
   - プレイヤー操作用のキーボードイベントリスナー（矢印キー＋スペース）

4. **レンダリング**：
   - ボード状態は数値で保存（0＝空、1-7＝ピースタイプ、-1＝アクティブピース）
   - すべての視覚要素にインラインスタイルを使用
   - CSSモジュールや外部スタイルシートは不使用

### 主要な関数

- `isValidMove()`：ピース移動の衝突検出
- `lockPiece()`：ピース配置の確定とライン消去処理
- `rotate()`：ピース回転のためのマトリックス回転
- `renderBoard()`：ボード状態とアクティブピースを統合して表示

### 重要な実装詳細

1. **ハイドレーションの安全性**：初期ランダムピースは`useEffect`で設定し、ハイドレーションの不一致を防ぐ
2. **ピースの識別**：オブジェクト参照ではなく形状比較（`JSON.stringify`）を使用してピースタイプを識別
3. **ライン消去**：満杯の行を識別し、削除して、上部に空の行を追加

## 一般的なタスク

### 新機能の追加
ゲームメカニクスを変更する際は、状態管理セクション（26-46行目）とゲームロジックのコールバック（64-155行目）に注目してください。

### レンダリング問題のデバッグ
`renderBoard()`関数とレンダーセクションの色マッピングロジック（特に`backgroundColor`の計算）を確認してください。

### 操作方法の変更
キーボード操作は156行目付近から始まる`useEffect`フックで処理されています。